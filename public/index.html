<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Availability Calendar</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Shoelace -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/themes/light.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/shoelace-autoloader.js"></script>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div x-data="availabilityApp()" x-init="init()" class="container">
        <div class="header">
            <h1>Availability Calendar</h1>
            <p x-text="dateRangeText"></p>
        </div>
        
        <div x-show="error" class="error" x-text="error"></div>
        
        <div class="color-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: var(--sl-color-success-500);"></div>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fbbf24;"></div>
                <span>Maybe</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--sl-color-danger-500);"></div>
                <span>Unavailable</span>
            </div>
        </div>
        
        <div x-show="loading" class="loading">
            <sl-spinner></sl-spinner>
            <p>Loading availability...</p>
        </div>
        
        <div x-show="!loading && !error">
            <!-- View toggle -->
            <div class="view-toggle">
                <div 
                    class="view-tab"
                    :class="{ active: viewMode === 'individual' }"
                    @click="viewMode = 'individual'"
                >
                    My Availability
                </div>
                <div 
                    class="view-tab"
                    :class="{ active: viewMode === 'overview' }"
                    @click="viewMode = 'overview'"
                >
                    Team Overview
                </div>
            </div>
            
            <!-- Day tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <template x-for="(date, index) in dates" :key="date">
                        <div 
                            class="tab"
                            :class="{ active: selectedDateIndex === index }"
                            @click="selectedDateIndex = index"
                            x-text="formatDate(date)"
                        ></div>
                    </template>
                </div>
            </div>
            
            <!-- Individual view: Calendar grid for selected day -->
            <div x-show="viewMode === 'individual'" class="calendar-container">
                <div class="calendar-grid">
                    <!-- Header row -->
                    <div class="grid-header">
                        <span style="font-weight: 600; font-size: 1rem;">Hour</span>
                    </div>
                    <div class="status-buttons" style="background: var(--sl-color-primary-50); padding: 0.75rem; justify-content: center;">
                        <span style="font-weight: 600; font-size: 1rem;">Status</span>
                    </div>
                    
                    <!-- Rows for each hour -->
                    <template x-for="hour in hours" :key="hour">
                        <div style="display: contents;">
                            <div 
                                class="hour-label"
                                :class="getSlotClass(dates[selectedDateIndex], hour)"
                                x-text="String(hour).padStart(2, '0')"
                                :title="getSlotTitle(dates[selectedDateIndex], hour)"
                            ></div>
                            <div class="status-buttons">
                                <template x-for="status in statuses" :key="status">
                                    <div 
                                        class="status-button"
                                        :class="[status, { active: getSlotStatus(dates[selectedDateIndex], hour) === status }]"
                                        @click.stop="setSlotStatus(dates[selectedDateIndex], hour, status)"
                                        @touchstart.stop="setSlotStatus(dates[selectedDateIndex], hour, status)"
                                        :title="status.charAt(0).toUpperCase() + status.slice(1)"
                                    ></div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Overview view: Table showing all users -->
            <div x-show="viewMode === 'overview'" class="overview-container">
                <div class="overview-table">
                    <!-- Header row with hours -->
                    <div class="overview-header-row">
                        <div class="overview-user-header">User</div>
                        <template x-for="hour in hours" :key="hour">
                            <div class="overview-hour-header" x-text="String(hour).padStart(2, '0')"></div>
                        </template>
                    </div>
                    
                    <!-- Rows for each user -->
                    <template x-for="user in getAllUsers()" :key="user.user_id">
                        <div class="overview-user-row">
                            <div class="overview-user-name" x-text="user.display_name || 'User'"></div>
                            <template x-for="hour in hours" :key="hour">
                                <div 
                                    class="overview-cell"
                                    :class="getUserStatusClass(user.user_id, dates[selectedDateIndex], hour)"
                                    :title="getUserStatusTitle(user.user_id, dates[selectedDateIndex], hour)"
                                ></div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Logic -->
    <script src="app.js"></script>
</body>
</html>
